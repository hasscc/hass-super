#! /bin/sh

set -ex

case $(uname -m) in
    "aarch64" | "arm64") export MACHINE=${MACHINE:=qemuarm-64} ;;
    "armv6l" | "armv7l") export MACHINE=${MACHINE:=qemuarm} ;;
esac

xargs -0 -n1 < /proc/1/environ | sed "s/=\(.*\)/='\1'/" | while read line; do
    export "$line"
done
env >> /tmp/hassio.log

mount --make-shared "${DATA_SHARE:=/usr/share/hassio}"

if [ -f /usr/sbin/hassio-supervisor ]; then
    sleep 10
    ha core start >> /tmp/hassio.log
    sleep 20
    ha core start >> /tmp/hassio.log
    exit 0
fi

deb="/opt/hassio.deb"
if [ $(cat /etc/timezone) = "Asia/Shanghai" ]; then
    deb="/opt/hasscn.deb"
fi
dpkg --force-confdef --force-confold -i $deb
