#! /bin/sh

set -ex

if [ $(cat /etc/timezone) = "Asia/Shanghai" ]; then
  sed -i 's@download.docker.com@mirrors.ustc.edu.cn/docker-ce@g' /etc/apt/sources.list.d/docker.list
  wget -t 3 --random-wait -O /etc/apt/keyrings/docker.asc "https://mirrors.ustc.edu.cn/docker-ce/linux/debian/gpg"
  apt-get -qq update >/dev/null
fi

if [ -f /var/run/docker.pid ]; then
  exit 0
fi

function install_docker()
{
  if [ -f /opt/docker.deb ]; then
    dpkg -i /opt/docker.deb
  else
    apt-get install --no-install-recommends -y docker-ce
  fi
  docker version
}

install_docker

if [ -f /var/run/docker.pid ]; then
  exit 0
fi

if [ -f /usr/sbin/iptables-legacy ]; then
  update-alternatives --set iptables /usr/sbin/iptables-legacy
  install_docker
fi
